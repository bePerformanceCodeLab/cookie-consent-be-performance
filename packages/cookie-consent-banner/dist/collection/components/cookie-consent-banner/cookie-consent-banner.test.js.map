{"version":3,"file":"cookie-consent-banner.test.js","sourceRoot":"","sources":["../../../src/components/cookie-consent-banner/cookie-consent-banner.test.ts"],"names":[],"mappings":"AAAA,OAAO,EAAW,UAAU,EAAE,MAAM,uBAAuB,CAAC;AAG5D,MAAM,2BAA2B,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;CAyBnC,CAAC;AAEF,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;IACrC,IAAI,IAAa,CAAC;IAElB,MAAM,mBAAmB,GAAG,KAAK,EAAE,aAAqB,EAAiB,EAAE;QACzE,kDAAkD;QAClD,yEAAyE;QACzE,MAAM,IAAI,CAAC,QAAQ,CAAC,CAAC,KAAK,EAAE,EAAE;YAE1B,QAAQ;iBACL,aAAa,CAAC,uBAAuB,CAAC;gBACvC,EAAE,UAAU,EAAE,aAAa,CAAC,KAAK,CACpC,EAAE,KAAK,EAAE,CAAC;QACb,CAAC,EAAE,aAAa,CAAC,CAAC;IACpB,CAAC,CAAC;IAEF,MAAM,gBAAgB,GAAG,KAAK,IAE5B,EAAE,CACF,CAAC,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,IAAI,CACzB,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,6BAA6B,CAC1D,CAAC;IAEJ,UAAU,CAAC,KAAK,IAAI,EAAE;QACpB,IAAI,GAAG,MAAM,UAAU,EAAE,CAAC;QAE1B,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;IAC9B,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,KAAK,IAAI,EAAE;QACnB,MAAM,IAAI,CAAC,YAAY,CACrB;YACE,IAAI,EAAE,6BAA6B;SACpC,EACD,EAAE,IAAI,EAAE,qBAAqB,EAAE,CAChC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,eAAe,EAAE,KAAK,IAAI,EAAE;QAC7B,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QAEnD,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;QAE9D,MAAM,CAAC,YAAY,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;QACpC,MAAM,CAAC,YAAY,CAAC,CAAC,aAAa,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;IACnD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,2CAA2C,EAAE,KAAK,IAAI,EAAE;QACzD,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,oBAAoB,GAAG,MAAM,IAAI,CAAC,IAAI,CAC1C,+BAA+B,CAChC,CAAC;QAEF,MAAM,CAAC,oBAAoB,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;IAC9C,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE;QAC5E,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,IAAI,CAAC,SAAS,CAAC;YACnB,IAAI,EAAE,qBAAqB;YAC3B,KAAK,EAAE,WAAW;YAClB,MAAM,EAAE,WAAW;SACpB,CAAC,CAAC;QACH,MAAM,oBAAoB,GAAG,MAAM,IAAI,CAAC,IAAI,CAC1C,+BAA+B,CAChC,CAAC;QAEF,MAAM,CAAC,oBAAoB,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;IAC9C,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,qDAAqD,EAAE,KAAK,IAAI,EAAE;QACnE,sDAAsD;QACtD,MAAM,IAAI,CAAC,SAAS,CAAC;YACnB,IAAI,EAAE,6BAA6B;YACnC,KAAK,EAAE,kBAAkB,CAAC,gCAAgC,CAAC;YAC3D,MAAM,EAAE,WAAW;SACpB,CAAC,CAAC;QACH,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,oBAAoB,GAAG,MAAM,IAAI,CAAC,IAAI,CAC1C,+BAA+B,CAChC,CAAC;QAEF,MAAM,CAAC,oBAAoB,CAAC,CAAC,QAAQ,EAAE,CAAC;IAC1C,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,wEAAwE,EAAE,KAAK,IAAI,EAAE;QACtF,sDAAsD;QACtD,MAAM,IAAI,CAAC,SAAS,CAAC;YACnB,IAAI,EAAE,6BAA6B;YACnC,KAAK,EAAE,kBAAkB,CAAC,gCAAgC,CAAC;YAC3D,MAAM,EAAE,WAAW;SACpB,CAAC,CAAC;QAEH,MAAM,IAAI,CAAC,SAAS,CAAC;YACnB,IAAI,EAAE,qBAAqB;YAC3B,KAAK,EAAE,WAAW;YAClB,MAAM,EAAE,WAAW;SACpB,CAAC,CAAC;QACH,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,oBAAoB,GAAG,MAAM,IAAI,CAAC,IAAI,CAC1C,+BAA+B,CAChC,CAAC;QAEF,MAAM,CAAC,oBAAoB,CAAC,CAAC,QAAQ,EAAE,CAAC;IAC1C,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,4GAA4G,EAAE,KAAK,IAAI,EAAE;QAC1H,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC5B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;QAExD,MAAM,CAAC,WAAW,CAAC,qBAAqB,EAAE;YACxC;gBACE,WAAW,EACT,8EAA8E;gBAChF,GAAG,EAAE,sBAAsB;gBAC3B,KAAK,EAAE,+BAA+B;gBACtC,WAAW,EAAE,IAAI;aAClB;YACD;gBACE,WAAW,EACT,wGAAwG;gBAC1G,GAAG,EAAE,WAAW;gBAChB,KAAK,EAAE,mBAAmB;aAC3B;SACF,CAAC,CAAC;QACH,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE5B,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,IAAI,CAClC,2CAA2C,CAC5C,CAAC;QACF,MAAM,CAAC,YAAY,CAAC,CAAC,WAAW,CAAC,oBAAoB,CAAC,CAAC;QACvD,MAAM,mBAAmB,CAAC,iBAAiB,CAAC,CAAC;QAC7C,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE5B,kFAAkF;QAClF,MAAM,wBAAwB,GAAG,CAAC,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,IAAI,CAC1D,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,6BAA6B,CAC1D,CAAC;QACF,MAAM,CAAC,wBAAwB,EAAE,KAAK,CAAC,CAAC,IAAI,CAC1C,kBAAkB,CAAC,gCAAgC,CAAC,CACrD,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,qGAAqG,EAAE,KAAK,IAAI,EAAE;QACnH,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC5B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;QAExD,MAAM,CAAC,WAAW,CAAC,qBAAqB,EAAE;YACxC;gBACE,WAAW,EACT,8EAA8E;gBAChF,GAAG,EAAE,sBAAsB;gBAC3B,KAAK,EAAE,+BAA+B;gBACtC,WAAW,EAAE,IAAI;aAClB;YACD;gBACE,WAAW,EACT,wGAAwG;gBAC1G,GAAG,EAAE,WAAW;gBAChB,KAAK,EAAE,mBAAmB;aAC3B;SACF,CAAC,CAAC;QACH,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE5B,MAAM,kBAAkB,GAAG,MAAM,IAAI,CAAC,IAAI,CACxC,gDAAgD,CACjD,CAAC;QACF,MAAM,CAAC,kBAAkB,CAAC,CAAC,WAAW,CACpC,iDAAiD,CAClD,CAAC;QACF,MAAM,mBAAmB,CAAC,sBAAsB,CAAC,CAAC;QAClD,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE5B,kFAAkF;QAClF,MAAM,wBAAwB,GAAG,MAAM,gBAAgB,EAAE,CAAC;QAC1D,MAAM,CAAC,wBAAwB,EAAE,KAAK,CAAC,CAAC,IAAI,CAC1C,kBAAkB,CAAC,sBAAsB,CAAC,CAC3C,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,qFAAqF,EAAE,KAAK,IAAI,EAAE;QACnG,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,CAAC;QACnD,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE5B,MAAM,OAAO,GAAG,IAAI,IAAI,EAAE,CAAC;QAC3B,iFAAiF;QACjF,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC,CAAC;QAEvC,MAAM,IAAI,CAAC,KAAK,CACd,uBAAuB;QACvB,8DAA8D;QAC9D,CAAC,GAAQ,EAAE,iBAAiB,EAAE,EAAE;YAC9B,mFAAmF;YACnF,+BAA+B;YAC/B,iDAAiD;YACjD,GAAG,CAAC,mBAAmB,GAAG;gBACxB;oBACE,WAAW,EACT,8EAA8E;oBAChF,GAAG,EAAE,sBAAsB;oBAC3B,KAAK,EAAE,+BAA+B;oBACtC,WAAW,EAAE,IAAI;iBAClB;aACF,CAAC;YACF,GAAG,CAAC,gBAAgB,GAAG;gBACrB,OAAO,EAAE,IAAI,IAAI,CAAC,iBAAiB,CAAC;gBACpC,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,KAAK;aAChB,CAAC;QACJ,CAAC,EACD,OAAO,CAAC,OAAO,EAAE,CAClB,CAAC;QACF,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAC5B,MAAM,mBAAmB,CAAC,iBAAiB,CAAC,CAAC;QAC7C,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE5B,MAAM,wBAAwB,GAAG,MAAM,gBAAgB,EAAE,CAAC;QAE1D,MAAM,CAAC,wBAAwB,EAAE,OAAO,CAAC,CAAC,IAAI;QAC5C,+DAA+D;QAC/D,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,CACrC,CAAC;QACF,MAAM,CAAC,wBAAwB,EAAE,MAAM,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACpD,MAAM,CAAC,wBAAwB,EAAE,QAAQ,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAEvD,MAAM,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IACpB,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["import { E2EPage, newE2EPage } from \"@stencil/core/testing\";\nimport type { Protocol } from \"puppeteer\";\n\nconst cookieBannerFullyConfigured = `\n<cookie-consent-banner\n  btn-label-accept-and-continue=\"Agree and continue\"\n  btn-label-only-essential-and-continue=\"Continue with technically required cookies only\"\n  btn-label-persist-selection-and-continue=\"Save selection and continue\"\n  btn-label-select-all-and-continue=\"Select all and continue\"\n  content-settings-description=\"You can decide which cookies are used by selecting the respective options below. Please note that your selection may impair in the functionality of the service.\"\n>\n  We use cookies and similar technologies to provide certain features,\n  enhance the user experience and deliver content that is relevant to your\n  interests. Depending on their purpose, Analytics and marketing cookies may\n  be used in addition to technically necessary cookies. By clicking on\n  \"Agree and continue\", you declare your consent to the use of the\n  aforementioned cookies.\n  <a\n    href=\"javascript:document.dispatchEvent(new Event('cookie_consent_details_show'))\"\n  >\n    Here\n  </a>\n  you can make detailed settings or revoke your consent (in part if\n  necessary) with effect for the future. For further information, please\n  refer to our\n  <a href=\"/privacy-policy\">Privacy Policy</a>\n  .\n</cookie-consent-banner>\n`;\n\ndescribe(\"Cookie Consent Banner\", () => {\n  let page: E2EPage;\n\n  const clickInCookieBanner = async (innerSelector: string): Promise<void> => {\n    // somehow .click() doesn't work in the shadow dom\n    // (Puppeteer Error \"Node is either not clickable or not an HTMLElement\")\n    await page.evaluate((inner) => {\n      (\n        document\n          .querySelector(\"cookie-consent-banner\")\n          ?.shadowRoot?.querySelector(inner) as HTMLElement | undefined\n      )?.click();\n    }, innerSelector);\n  };\n\n  const getConsentCookie = async (): Promise<\n    Protocol.Network.Cookie | undefined\n  > =>\n    (await page.cookies()).find(\n      (cookie) => cookie.name === \"cookies_accepted_categories\",\n    );\n\n  beforeEach(async () => {\n    page = await newE2EPage();\n\n    await page.waitForChanges();\n  });\n\n  afterEach(async () => {\n    await page.deleteCookie(\n      {\n        name: \"cookies_accepted_categories\",\n      },\n      { name: \"someUnrelatedCookie\" },\n    );\n  });\n\n  it(\"should render\", async () => {\n    await page.setContent(cookieBannerFullyConfigured);\n\n    const cookieBanner = await page.find(\"cookie-consent-banner\");\n\n    expect(cookieBanner).not.toBeNull();\n    expect(cookieBanner).toHaveClasses([\"hydrated\"]);\n  });\n\n  it(\"should be displayed if no cookies are set\", async () => {\n    await page.setContent(cookieBannerFullyConfigured);\n    const cookieBannerInnerDiv = await page.find(\n      \"cookie-consent-banner >>> .cc\",\n    );\n\n    expect(cookieBannerInnerDiv).not.toBeNull();\n  });\n\n  it(\"should be displayed if cookies other than cookieName are set\", async () => {\n    await page.setContent(cookieBannerFullyConfigured);\n    await page.setCookie({\n      name: \"someUnrelatedCookie\",\n      value: \"someValue\",\n      domain: \"localhost\",\n    });\n    const cookieBannerInnerDiv = await page.find(\n      \"cookie-consent-banner >>> .cc\",\n    );\n\n    expect(cookieBannerInnerDiv).not.toBeNull();\n  });\n\n  it(\"should not be displayed if cookieName cookie is set\", async () => {\n    // default `cookieName` is cookies_accepted_categories\n    await page.setCookie({\n      name: \"cookies_accepted_categories\",\n      value: encodeURIComponent(\"technically_required,analytics\"),\n      domain: \"localhost\",\n    });\n    await page.setContent(cookieBannerFullyConfigured);\n    const cookieBannerInnerDiv = await page.find(\n      \"cookie-consent-banner >>> .cc\",\n    );\n\n    expect(cookieBannerInnerDiv).toBeNull();\n  });\n\n  it(\"should not be displayed if cookieName cookie and other cookies are set\", async () => {\n    // default `cookieName` is cookies_accepted_categories\n    await page.setCookie({\n      name: \"cookies_accepted_categories\",\n      value: encodeURIComponent(\"technically_required,analytics\"),\n      domain: \"localhost\",\n    });\n\n    await page.setCookie({\n      name: \"someUnrelatedCookie\",\n      value: \"someValue\",\n      domain: \"localhost\",\n    });\n    await page.setContent(cookieBannerFullyConfigured);\n    const cookieBannerInnerDiv = await page.find(\n      \"cookie-consent-banner >>> .cc\",\n    );\n\n    expect(cookieBannerInnerDiv).toBeNull();\n  });\n\n  it(\"should set cookies_accepted_categories to all passed cookie categories when 'Accept All' button is clicked\", async () => {\n    await page.setContent(cookieBannerFullyConfigured);\n    await page.waitForChanges();\n    const banner = await page.find(\"cookie-consent-banner\");\n\n    banner.setProperty(\"availableCategories\", [\n      {\n        description:\n          \"Enable you to navigate and use the basic functions and to store preferences.\",\n        key: \"technically_required\",\n        label: \"Technically necessary cookies\",\n        isMandatory: true,\n      },\n      {\n        description:\n          \"Enable us to determine how visitors interact with our service in order to improve the user experience.\",\n        key: \"analytics\",\n        label: \"Analytics cookies\",\n      },\n    ]);\n    await page.waitForChanges();\n\n    const acceptAllBtn = await page.find(\n      \"cookie-consent-banner >>> .btn_accept_all\",\n    );\n    expect(acceptAllBtn).toEqualText(\"Agree and continue\");\n    await clickInCookieBanner(\".btn_accept_all\");\n    await page.waitForChanges();\n\n    // Check if cookies_accepted_categories is set to \"technically_required,analytics\"\n    const cookieAcceptedCategories = (await page.cookies()).find(\n      (cookie) => cookie.name === \"cookies_accepted_categories\",\n    );\n    expect(cookieAcceptedCategories?.value).toBe(\n      encodeURIComponent(\"technically_required,analytics\"),\n    );\n  });\n\n  it(\"should set cookies_accepted_categories to only the mandatory when 'Only required' button is clicked\", async () => {\n    await page.setContent(cookieBannerFullyConfigured);\n    await page.waitForChanges();\n    const banner = await page.find(\"cookie-consent-banner\");\n\n    banner.setProperty(\"availableCategories\", [\n      {\n        description:\n          \"Enable you to navigate and use the basic functions and to store preferences.\",\n        key: \"technically_required\",\n        label: \"Technically necessary cookies\",\n        isMandatory: true,\n      },\n      {\n        description:\n          \"Enable us to determine how visitors interact with our service in order to improve the user experience.\",\n        key: \"analytics\",\n        label: \"Analytics cookies\",\n      },\n    ]);\n    await page.waitForChanges();\n\n    const onlyRequiredButton = await page.find(\n      \"cookie-consent-banner >>> .btn_essentials_only\",\n    );\n    expect(onlyRequiredButton).toEqualText(\n      \"Continue with technically required cookies only\",\n    );\n    await clickInCookieBanner(\".btn_essentials_only\");\n    await page.waitForChanges();\n\n    // Check if cookies_accepted_categories is set to \"technically_required,analytics\"\n    const cookieAcceptedCategories = await getConsentCookie();\n    expect(cookieAcceptedCategories?.value).toBe(\n      encodeURIComponent(\"technically_required\"),\n    );\n  });\n\n  it(\"should set the cookies_accepted_categories cookie with all passed cookie attributes\", async () => {\n    await page.setContent(cookieBannerFullyConfigured);\n    await page.waitForChanges();\n\n    const inAWeek = new Date();\n    // eslint-disable-next-line no-magic-numbers, @typescript-eslint/no-magic-numbers\n    inAWeek.setDate(inAWeek.getDate() + 7);\n\n    await page.$eval(\n      \"cookie-consent-banner\",\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (elm: any, _inAWeekTimestamp) => {\n        /* eslint-disable @typescript-eslint/no-unsafe-member-access, no-param-reassign  */\n        // within the browser's context\n        // let's set new property values on the component\n        elm.availableCategories = [\n          {\n            description:\n              \"Enable you to navigate and use the basic functions and to store preferences.\",\n            key: \"technically_required\",\n            label: \"Technically necessary cookies\",\n            isMandatory: true,\n          },\n        ];\n        elm.cookieAttributes = {\n          expires: new Date(_inAWeekTimestamp),\n          secure: true,\n          sameSite: \"lax\",\n        };\n      },\n      inAWeek.getTime(),\n    );\n    await page.waitForChanges();\n    await clickInCookieBanner(\".btn_accept_all\");\n    await page.waitForChanges();\n\n    const cookieAcceptedCategories = await getConsentCookie();\n\n    expect(cookieAcceptedCategories?.expires).toBe(\n      // eslint-disable-next-line @typescript-eslint/no-magic-numbers\n      Math.floor(inAWeek.getTime() / 1000), // Puppeteer returns seconds, JS uses milliseconds\n    );\n    expect(cookieAcceptedCategories?.secure).toBe(true);\n    expect(cookieAcceptedCategories?.sameSite).toBe(\"Lax\");\n\n    expect(0).toBe(0);\n  });\n});\n"]}